@prefix base:               <https://www.theworldavatar.io/kg/service/> .
@prefix ontoprofile:        <https://www.theworldavatar.com/kg/ontoprofile/> .
@prefix ontoservice:        <https://www.theworldavatar.com/kg/ontoservice/> .
@prefix rdfs:               <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh:                 <http://www.w3.org/ns/shacl#> .
@prefix xsd:                <http://www.w3.org/2001/XMLSchema#> .
@prefix cmns-col:           <https://www.omg.org/spec/Commons/Collections/> .
@prefix cmns-qtu:           <https://www.omg.org/spec/Commons/QuantitiesAndUnits/> .
@prefix fibo-fbc-pas-fpas:  <https://spec.edmcouncil.org/fibo/ontology/FBC/ProductsAndServices/FinancialProductsAndServices/> .
@prefix fibo-fnd-dt-oc:     <https://spec.edmcouncil.org/fibo/ontology/FND/DatesAndTimes/Occurrences/> .
@prefix fibo-fnd-rel-rel:   <https://spec.edmcouncil.org/fibo/ontology/FND/Relations/Relations/> .
@prefix p2p-o-inv:          <https://purl.org/p2p-o/invoice#> .
@prefix p2p-o-doc-line:     <https://purl.org/p2p-o/documentline#> .

base:ServiceDispatchOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ServiceDispatchEvent ;
  ] ; 
  sh:property [
    sh:name "driver";
    sh:description "Assign a driver to perform the service.";
    sh:order 0;
    sh:path fibo-fnd-rel-rel:designates ;
    sh:class ontoprofile:EmployedDriver ;
    sh:minCount 0 ;
    sh:maxCount 1 ;
  ] .

base:ServiceOrderCompletedOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ServiceDeliveryEvent ;
  ] ; 
  sh:property [
    sh:name "weight log";
    sh:description "Records the weight measured at the end of the service.";
    sh:order 0;
    sh:path (
        [sh:inversePath cmns-col:comprises]
        cmns-col:comprises
      ) ;
    sh:node base:WeightLogShape ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .

base:WeightLogShape
  a sh:NodeShape ;
  sh:targetClass fibo-fnd-dt-oc:Calculation ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue fibo-fnd-dt-oc:CalculationEvent ;
  ] ; 
  sh:property [
    sh:name "gross weight";
    sh:description "The weight of the delivered good.";
    sh:order 0 ;
    sh:path (
        cmns-qtu:hasExpression
        cmns-qtu:hasArgument
        cmns-qtu:hasNumericValue
      ) ;
    sh:datatype xsd:decimal ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .

base:ServiceTerminationOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:TerminatedServiceEvent ;
  ] ; 
  sh:property [
    sh:name "remarks";
    sh:description "Please provide the reason for cancellation. Include any relevant details or circumstances that led to this decision.";
    sh:order 0;
    sh:path rdfs:comment ;
    sh:datatype xsd:string ;
    sh:minCount 0 ;
    sh:maxCount 1 ;
  ] .

base:ServiceReportOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:IncidentReportEvent ;
  ] ; 
  sh:property [
    sh:name "remarks";
    sh:description "Describe the incident in detail in this report.";
    sh:order 0;
    sh:path rdfs:comment ;
    sh:datatype xsd:string ;
    sh:minCount 0 ;
    sh:maxCount 1 ;
  ] .

base:ServicAccrualOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ServiceAccrualEvent ;
  ] ; 
  sh:property [
    sh:name "po";
    sh:description "The purchase order number";
    sh:order 0;
    sh:path (
      [sh:inversePath cmns-doc:isAbout]
      p2p-o-inv:invoiceObjectIdentifier
    ) ;
    sh:datatype xsd:string ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] ;
  sh:property [
    sh:name "additional charges" ;
    sh:description "Additional charges to be added to total charge." ;
    sh:order 1;
    sh:path (
      [sh:inversePath cmns-doc:isAbout]
      p2p-o-inv:hasInvoiceLine
    ) ;
    sh:node base:AddChargeInvoiceLineShape ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .

base:AddChargeInvoiceLineShape
	a sh:NodeShape ;
  sh:property [
    sh:name "amount" ;
    sh:description "Amount of charges to be added." ;
    sh:order 0;
    sh:path (
      p2p-o-doc-line:hasGrosspriceOfItem 
      cmns-qtu:hasNumericValue
      ) ;
    sh:datatype xsd:decimal ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] ;
  sh:property [
    sh:name "description" ;
    sh:description "Describes the nature of the charges." ;
    sh:order 1;
    sh:path p2p-o-doc-line:lineNote ;
    sh:datatype xsd:string ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .

base:ContractRescissionOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ContractRescission ;
  ] ; 
  sh:property [
    sh:name "remarks";
    sh:description "State the reasons for rescinding the contract.";
    sh:order 0;
    sh:path rdfs:comment ;
    sh:datatype xsd:string ;
    sh:minCount 0 ;
    sh:maxCount 1 ;
  ] .

base:ContractTerminationOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ContractTermination ;
  ] ; 
  sh:property [
    sh:name "remarks";
    sh:description "State the reasons for terminating the contract.";
    sh:order 0;
    sh:path rdfs:comment ;
    sh:datatype xsd:string ;
    sh:minCount 0 ;
    sh:maxCount 1 ;
  ] .

base:ServiceAccrualOccurrenceShape
  a sh:NodeShape ;
  sh:targetClass fibo-fbc-pas-fpas:ContractLifecycleEventOccurrence ;
  sh:property [
    sh:path fibo-fnd-rel-rel:exemplifies ;
    sh:hasValue ontoservice:ServiceAccrualEvent ;
  ] ; 
  sh:property [
    sh:name "discounts" ;
    sh:description "Discounts to be subtracted from the total charge." ;
    sh:order 1;
    sh:path (
      [sh:inversePath cmns-doc:isAbout]
      p2p-o-inv:hasInvoiceLine
    ) ;
    sh:node base:DiscountInvoiceLineShape ;
    sh:minCount 0 ;
  ] ;
  sh:property [
    sh:name "additional charges" ;
    sh:description "Additional charges to be added to total charge." ;
    sh:order 2;
    sh:path (
      [sh:inversePath cmns-doc:isAbout]
      p2p-o-inv:hasInvoiceLine
    ) ;
    sh:node base:AddChargeInvoiceLineShape ;
    sh:minCount 0 ;
  ] ;
  sh:rule [
    a sh:SPARQLRule ;
    sh:order 0 ;
    sh:construct """
    PREFIX cmns-col: <https://www.omg.org/spec/Commons/Collections/>
    PREFIX cmns-doc: <https://www.omg.org/spec/Commons/Documents/>
    PREFIX cmns-dsg: <https://www.omg.org/spec/Commons/Designators/>
    PREFIX cmns-dt:  <https://www.omg.org/spec/Commons/DatesAndTimes/>
    PREFIX cmns-qtu: <https://www.omg.org/spec/Commons/QuantitiesAndUnits/>
    PREFIX dc-terms: <http://purl.org/dc/terms/>

    PREFIX fibo-fnd-acc-cur: <https://spec.edmcouncil.org/fibo/ontology/FND/Accounting/CurrencyAmount/>
    PREFIX fibo-fnd-arr-lif: <https://spec.edmcouncil.org/fibo/ontology/FND/Arrangements/Lifecycles/>
    PREFIX fibo-fnd-rel-rel: <https://spec.edmcouncil.org/fibo/ontology/FND/Relations/Relations/>
    PREFIX fibo-fnd-pas-pas: <https://spec.edmcouncil.org/fibo/ontology/FND/ProductsAndServices/ProductsAndServices/>
    PREFIX p2p-o-doc-line:   <https://purl.org/p2p-o/documentline#>
    PREFIX p2p-o-inv:        <https://purl.org/p2p-o/invoice#>
    PREFIX ontoservice:      <https://www.theworldavatar.com/kg/ontoservice/>
    PREFIX xsd:              <http://www.w3.org/2001/XMLSchema#>

    CONSTRUCT {
      ?invoice p2p-o-inv:hasInvoiceLine ?invoice_line_base_instance;
        p2p-o-inv:hasInvoiceLine ?invoice_line_variable_instance.
      ?invoice_line_base_instance a p2p-o-doc-line:InvoiceLine;
        p2p-o-doc-line:lineIdentifier "0"^^xsd:string;
        p2p-o-doc-line:lineNote "Base fee charge"^^xsd:string;
        p2p-o-doc-line:hasGrosspriceOfItem ?invoice_line_base_amount_instance.
      ?invoice_line_base_amount_instance cmns-qtu:hasNumericValue ?base_fee.
      ?invoice_line_variable_instance a p2p-o-doc-line:InvoiceLine;
        p2p-o-doc-line:lineIdentifier "1"^^xsd:string;
        p2p-o-doc-line:lineNote ?service_price_description;
        p2p-o-doc-line:hasGrosspriceOfItem ?invoice_line_variable_amount_instance.
      ?invoice_line_variable_amount_instance cmns-qtu:hasNumericValue ?var_price.
    } WHERE { 
      ?this cmns-dt:succeeds ?event_id;
        dc-terms:identifier ?id.
      ?invoice cmns-doc:isAbout ?this.
      ?iri a fibo-fnd-pas-pas:ServiceAgreement;
        fibo-fnd-arr-lif:hasLifecycle/fibo-fnd-arr-lif:hasStage/cmns-col:comprises ?event_id;
        fibo-fnd-rel-rel:confers/fibo-fnd-rel-rel:mandates ?price_model.
      ?event_id ^cmns-doc:refersTo/cmns-doc:records/cmns-qtu:hasQuantityValue ?weight;
        fibo-fnd-rel-rel:exemplifies ontoservice:ServiceDeliveryEvent;
        cmns-dsg:describes ontoservice:CompletedStatus .
      ?price_model cmns-qtu:hasArgument/fibo-fnd-acc-cur:hasAmount ?base_fee;
        cmns-qtu:hasArgument ?var_fee_instance.
      ?base_fee ^fibo-fnd-acc-cur:hasAmount/a ontoservice:BaseFee.
      ?var_fee_instance a ontoservice:VariableFee;
        fibo-fnd-acc-cur:hasAmount ?var_fee;
        cmns-qtu:hasLowerBound/cmns-qtu:hasNumericValue ?lower_bound.
      BIND(IF(BOUND(?status),
        ?var_fee * IF(?weight > ?lower_bound, ?weight - ?lower_bound, 0.0),
        ?null) AS ?var_price)
      BIND(IRI(CONCAT("https://theworldavatar.io/kg/account/transaction/invoice/line/base/",?id)) AS ?invoice_line_base_instance)
      BIND(IRI(CONCAT("https://theworldavatar.io/kg/account/transaction/invoice/line/base/amount/",?id)) AS ?invoice_line_base_amount_instance)
      BIND(IF(BOUND(?var_price),IRI(CONCAT("https://theworldavatar.io/kg/account/transaction/invoice/line/var/",?id)), ?null) AS ?invoice_line_variable_instance)
      BIND(IF(BOUND(?var_price),IRI(CONCAT("https://theworldavatar.io/kg/account/transaction/invoice/line/var/amount/",?id)), ?null) AS ?invoice_line_variable_amount_instance)
      BIND(IF(BOUND(?var_price),CONCAT("<b>Variable fee charge - Rate: $",STR(?var_fee),"/ton; From: ",  STR(?lower_bound), "tons; Total weight: ", STR(?weight), "tons</b>"), ?null) AS ?service_price_description)
    }
    """
  ] ;
  sh:rule [
    a sh:SPARQLRule ;
    sh:order 1 ;
    sh:construct """
    PREFIX cmns-doc:        <https://www.omg.org/spec/Commons/Documents/>
    PREFIX cmns-dt:         <https://www.omg.org/spec/Commons/DatesAndTimes/>
    PREFIX cmns-qtu:        <https://www.omg.org/spec/Commons/QuantitiesAndUnits/>
    PREFIX dc-terms:        <http://purl.org/dc/terms/>
    PREFIX fibo-fnd-acc-cur:<https://spec.edmcouncil.org/fibo/ontology/FND/Accounting/CurrencyAmount/>
    PREFIX fibo-fnd-rel-rel:<https://spec.edmcouncil.org/fibo/ontology/FND/Relations/Relations/>
    PREFIX p2p-o-doc-line:  <https://purl.org/p2p-o/documentline#>
    PREFIX p2p-o-inv:       <https://purl.org/p2p-o/invoice#>
    PREFIX ontoservice:     <https://www.theworldavatar.com/kg/ontoservice/>
    PREFIX xsd:             <http://www.w3.org/2001/XMLSchema#>

    CONSTRUCT {
      ?invoice p2p-o-inv:hasTotalAmountWithVAT ?total_instance.
      ?total_instance a fibo-fnd-acc-cur:CalculatedPrice; 
        fibo-fnd-acc-cur:hasAmount ?total.
    } WHERE { 
      ?this cmns-dt:succeeds ?event_id;
        dc-terms:identifier ?id.
      ?invoice cmns-doc:isAbout ?this.
      OPTIONAL{
        SELECT ?invoice (SUM(?charge) AS ?temp_add_charges) WHERE {
          ?invoice cmns-doc:isAbout ?this.
          ?invoice p2p-o-inv:hasInvoiceLine/p2p-o-doc-line:hasGrosspriceOfItem/cmns-qtu:hasNumericValue ?charge .
        } GROUP BY ?invoice 
      }
      BIND(COALESCE(?temp_add_charges,0) AS ?add_charges)
      OPTIONAL{ 
        SELECT ?invoice (SUM(?charge) AS ?temp_discount) WHERE {
          ?invoice cmns-doc:isAbout ?this.
          ?invoice p2p-o-inv:hasInvoiceLine/p2p-o-doc-line:hasPriceDiscountOfItem/cmns-qtu:hasNumericValue ?charge .
        } GROUP BY ?invoice }
      BIND(COALESCE(?temp_discount,0) AS ?discount)
      BIND(?add_charges-?discount AS ?total)
      BIND(IRI(CONCAT("https://theworldavatar.io/kg/account/transaction/total/",?id)) AS ?total_instance)
    }
    """
  ] .

  base:DiscountInvoiceLineShape
	a sh:NodeShape ;
  sh:property [
    sh:name "discount" ;
    sh:description "Amount of discount to be applied." ;
    sh:order 0;
    sh:path (
      p2p-o-doc-line:hasPriceDiscountOfItem 
      cmns-qtu:hasNumericValue
      ) ;
    sh:datatype xsd:decimal ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] ;
  sh:property [
    sh:name "description" ;
    sh:description "Describes the nature of the discount." ;
    sh:order 1;
    sh:path p2p-o-doc-line:lineNote ;
    sh:datatype xsd:string ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .

base:AddChargeInvoiceLineShape
	a sh:NodeShape ;
  sh:property [
    sh:name "amount" ;
    sh:description "Amount of charges to be added." ;
    sh:order 0;
    sh:path (
      p2p-o-doc-line:hasGrosspriceOfItem 
      cmns-qtu:hasNumericValue
      ) ;
    sh:datatype xsd:decimal ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] ;
  sh:property [
    sh:name "description" ;
    sh:description "Describes the nature of the charges." ;
    sh:order 1;
    sh:path (
      p2p-o-item:hasItem
      p2p-o-item:itemDescription
      ) ;
    sh:datatype xsd:string ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .